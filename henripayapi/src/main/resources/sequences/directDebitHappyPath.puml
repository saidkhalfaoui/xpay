@startuml
'https://plantuml.com/sequence-diagram
entity "Merchant" as merchant

participant "HenriPay Engine" as HenriPay
participant "SepaDD service" as iso
participant "Mandate Service" as mandateService
participant "User service" as userservice
participant "Encryption service" as encryptionService

merchant -> HenriPay : /collection {amount , customerid , mandateid}
HenriPay--> HenriPay: validation , business rules
HenriPay->userservice: get user details
userservice->encryptionService: decrypt sensetive data
encryptionService-->userservice : decrypted accountinfo
userservice-->HenriPay: user accountInfo
HenriPay->mandateService: get mandate details
mandateService-->HenriPay: mandate info
HenriPay-> iso: Add Direct Debit Transaction
HenriPay-->merchant : {success}
iso-->iso : create payment 008.001 file
iso->Bank : batch payment file (scheduled job)
Bank-->Bank: process payment
Bank->iso: Reporting file camt.005.001
iso-->iso : process report file
HenriPay-> iso : get Transaction status
iso-->HenriPay : transaction status (success)
HenriPay-> iso : add Credit Transfer transaction
iso-->iso: create payment 002.001 file
iso-> Bank: batch payment file (scheduled job)
Bank--> Bank : process payment order
Bank ->iso : Reporting file camt.005.001
iso --> iso : process report file
HenriPay --> iso : get transaction status
iso-->HenriPay : transaction status (success)
HenriPay -> merchant : Completion notification

@enduml